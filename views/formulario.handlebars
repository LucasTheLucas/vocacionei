<div class="container mt-5 py-5">
  <div class="card shadow p-4">
    <h2 class="mb-4">Cadastro</h2>

    <form action="/addaluno" method="POST" id="cadastroForm">
      <div class="mb-3">
        <label class="form-label">Nome</label>
        <input type="text" class="form-control" name="nome" required />
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" name="email" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Contato</label>
          <input type="text" class="form-control" name="contato" required />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Gênero</label>
          <select class="form-select" name="genero">
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Data de nascimento</label>
          <input type="date" class="form-control" name="nasc" required />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nome responsável</label>
          <input type="text" class="form-control" name="responsavel" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Contato do responsável</label>
          <input type="text" class="form-control" name="responsavelcontato" required />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Instituição de ensino</label>
          <select id="ensino" class="form-select" name="ensino">
            <option value="0">--SELECIONE UMA INSTITUIÇÃO--</option>
            {{#each instituicao}}
              <option value="{{id}}">{{nome}}</option>
            {{/each}}
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Série</label>
          <select class="form-select" name="serie">
            <option value="0">Não estuda</option>
            <option value="1">1° Fundamental I</option>
            <option value="2">2° Fundamental I</option>
            <option value="3">3° Fundamental I</option>
            <option value="4">4° Fundamental I</option>
            <option value="5">5° Fundamental I</option>
            <option value="6">6° Fundamental II</option>
            <option value="7">7° Fundamental II</option>
            <option value="8">8° Fundamental II</option>
            <option value="9">9° Fundamental II</option>
            <option value="10">1° Ensino Médio</option>
            <option value="11">2° Ensino Médio</option>
            <option value="12">3° Ensino Médio</option>
            <option value="13">Ensino Superior</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Rua</label>
          <input type="text" class="form-control" name="rua" required />
        </div>

        <div class="col-md-3">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" name="bairro" required />
        </div>

        <div class="col-md-2">
          <label class="form-label">Cidade</label>
          <select class="form-select" name="idcidade" required>
            <option value="0">--SELECIONE UMA CIDADE--</option>
            {{#each cidade}}
              <option value="{{id}}">{{nome}}</option>
            {{/each}}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Estado</label>
          <select class="form-select" name="estado" required>
            <option value="0">--SELECIONE UM ESTADO--</option>
            {{#each estado}}
              <option value="{{id}}">{{nome}}</option>
            {{/each}}
          </select>
        </div>

        <div class="col-md-1">
          <label class="form-label">Número</label>
          <input type="number" class="form-control" name="numero" required />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Senha</label>
          <input type="password" class="form-control" name="senha" id="senha" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Confirme a senha</label>
          <input type="password" class="form-control" name="senhaconf" id="senhaconf" required />
        </div>
      </div>

      <div class="form-check mb-4">
        <input class="form-check-input" type="checkbox" name="termos" required />
        <label class="form-check-label">
          Aceito os <a href="/termos">termos de serviço</a>
        </label>
      </div>

      <button type="submit" class="btn btn-primary btn-lg">Cadastrar</button>
    </form>
  </div>
</div>

<script>
function getParams() {
  const params = new URLSearchParams(window.location.search);
  return { login: params.get("login"), instituicao: params.get("instituicao"), serie: params.get("serie") };
}

window.addEventListener("DOMContentLoaded", () => {
  const {login, instituicao, serie } = getParams();
  const selectInstituicao = document.getElementById("ensino");
  const selectSerie = document.querySelector("select[name='serie']");

  if (instituicao && instituicao !== "0") {
    selectInstituicao.value = instituicao;
    selectInstituicao.disabled = true;
  }
  if (serie && serie !== "0") {
    selectSerie.value = serie;
    selectSerie.disabled = true;
  }
});

document.getElementById("cadastroForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const formData = Object.fromEntries(new FormData(this).entries());

  if (formData.senha !== formData.senhaconf) {
    Swal.fire({
      icon: "error",
      title: "Senhas não coincidem",
      text: "Por favor, verifique e tente novamente!"
    });
    return;
  }

  try {
    const res = await fetch("/addaluno", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const data = await res.json();
    localStorage.setItem("pessoaId", data.id);

    Swal.fire({
      icon: "success",
      title: "Cadastro concluído!",
      text: "Você será redirecionado...",
      timer: 2000,
      showConfirmButton: false
    });

    const { login } = getParams();

    setTimeout(() => {
      if (login === "true") {
        window.location.href = "http://localhost:8081/";
      } else {
        window.location.href = "http://localhost:8081/slides";
      }
    }, 2000);

  } catch (err) {
    Swal.fire({
      icon: "error",
      title: "Erro no servidor",
      text: "Tente novamente mais tarde."
    });
  }
});
</script>
